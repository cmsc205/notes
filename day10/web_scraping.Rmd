---
title: "Scraping Data From the Web"
output: html_notebook
---

## Set up for today

Install and load the `rvest` and `stringr`

```{r message=FALSE}
library(rvest)
library(stringr)
```


## Quick note on HTML

Web pages are written in HTML (Hyper Text Markup Language) which uses **tags** to describe different aspects of document content. 

* a heading in a document is indicated by `<h1>My Title</h1>` 
* a paragraph is indicated by  `<p>A paragraph of content...</p>`
* a table is indicated by `<table> ... </table>`


* * *

## Example 1

**Goal:** get the population data on  [Wikipedia](https://en.wikipedia.org/wiki/List_of_countries_by_population_in_1900) into R


First, we read the HTML into R

```{r}
pop_parse <- read_html("https://en.wikipedia.org/wiki/List_of_countries_by_population_in_1900")
str(pop_parse)
```

To extract a table from this web page

```{r}
pop_nodes <- html_nodes(pop_parse, "table")
str(pop_nodes)
pop_nodes
```

**Question:** There are 4 tables, which do we want?


```{r}
# Pull off the appropriate element of pop_nodes in first argument
pop <- html_table(pop_nodes, header = TRUE, fill = TRUE)
str(pop)
```


**Question:** Is the data set **clean**? If not, what do we need to do to clean it?


* * *

## Example 2

* [Box Office Mojo](http://www.boxofficemojo.com) gives statistics on box office earnings of movies. 

* Web site also maintains lists of yearly and all time record holders.

* We will look at the movies in the top 100 in all time movie worldwide grosses in box office receipts. 

* In particular, we will scrape the data from [Box Office Mojo: All Time Box Office](http://www.boxofficemojo.com/alltime/world/?pagenum=1). 

* The dollar amounts are in millions of dollars and the years marked with "^" indicate that the movie had multiple releases.


First, use `read_html` to read in the webpage

```{r}
movie_parse<- read_html("http://www.boxofficemojo.com/alltime/world/?pagenum=1")
```

Then, use `html_nodes` to grab the tables

```{r}
movie_tables <- html_nodes(movie_parse, "table")
movie_tables
```

Next, extract the desired table

```{r}
movies <- html_table(movie_tables[[3]], header = TRUE, fill = TRUE)
head(movies)
```


**Question:** Is the data set **clean**? If not, what do we need to do to clean it?


* * *


## Example 3

* The website [billboard.com](http://www.billboard.com)
keeps track of top songs and albums from the music industry.

* One page lists the top 200 albums for a given week. We will extract these albums. 

* In the source code, the songs are listed in headers:
`<h2 class = "chart-row__song">Album Name </h2>`.


First, we read in the webpage

```{r}
album_parse <- read_html("http://www.billboard.com/charts/billboard-200")
```

Then, we grab the necessary `<h2>` headers

```{r}
album_nodes <- html_nodes(albumParse, "h2")
album_nodes[1:10] # print first 10 elements of the list
```


There are other entries with `<h2>` headers besides the top songs, so we must first detect the nodes of interest.


```{r}
index <- str_detect(album_nodes, "chart-row__song")
index[1:10]

albums <- album_nodes[index]
albums[1:10]
```


Now, we just need to extract the album name which is placed between `<h2 ... >` and `</h2>`. We will use a regular expression to handle this.

```{r}
albums <- str_replace(albums, ".*\">(.+)</h2>","\\1")
albums[1:10]
```


In `str_replace` we consider three key pieces

1. 0 or more occurrences of any character followed by a `">`
2. 1 or more occurrences of any character---this is the `(.+)` portion of the regular expression
3. `</h2>`. 

This expression will be replaced by what is in the `(.+)` portion of the regular expression---this is what the `"\\1"` argument is accomplishing.



### Resources

* [HTML Tutorial](www.w3schools.com)